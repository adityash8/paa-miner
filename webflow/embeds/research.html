<!-- PAA Dominator - Research Tool Embed -->
<!-- Add this to a Webflow page using Custom Code embed -->

<div id="paa-research-tool">
  <!-- Input Section -->
  <div class="paa-input-section">
    <div class="paa-input-row">
      <input type="text" id="paa-keyword" class="paa-input" placeholder="Enter keyword (e.g., webflow seo tips)">
      <select id="paa-region" class="paa-select">
        <option value="us">ðŸ‡ºðŸ‡¸ United States</option>
        <option value="gb">ðŸ‡¬ðŸ‡§ United Kingdom</option>
        <option value="au">ðŸ‡¦ðŸ‡º Australia</option>
        <option value="ca">ðŸ‡¨ðŸ‡¦ Canada</option>
        <option value="de">ðŸ‡©ðŸ‡ª Germany</option>
        <option value="in">ðŸ‡®ðŸ‡³ India</option>
        <option value="fr">ðŸ‡«ðŸ‡· France</option>
        <option value="es">ðŸ‡ªðŸ‡¸ Spain</option>
        <option value="it">ðŸ‡®ðŸ‡¹ Italy</option>
        <option value="nl">ðŸ‡³ðŸ‡± Netherlands</option>
        <option value="br">ðŸ‡§ðŸ‡· Brazil</option>
        <option value="mx">ðŸ‡²ðŸ‡½ Mexico</option>
        <option value="jp">ðŸ‡¯ðŸ‡µ Japan</option>
      </select>
      <select id="paa-depth" class="paa-select">
        <option value="0">No expansion</option>
        <option value="1" selected>1 level deep</option>
        <option value="2">2 levels deep</option>
      </select>
      <button id="paa-fetch-btn" class="paa-btn paa-btn-primary">
        <span class="btn-text">Find Questions</span>
        <span class="btn-loading hidden">Searching...</span>
      </button>
    </div>
  </div>

  <!-- Results Section -->
  <div id="paa-results" class="paa-results hidden">
    <div class="paa-results-header">
      <div class="paa-results-stats">
        <span id="paa-total-count">0</span> questions found
        <span class="paa-selected-count">(<span id="paa-selected-count">0</span> selected)</span>
      </div>
      <div class="paa-results-actions">
        <button id="paa-select-all" class="paa-btn paa-btn-secondary">Select All</button>
        <button id="paa-deselect-all" class="paa-btn paa-btn-secondary">Deselect All</button>
      </div>
    </div>

    <div id="paa-questions-list" class="paa-questions-list"></div>

    <div class="paa-action-bar">
      <button id="paa-generate-btn" class="paa-btn paa-btn-primary" disabled>
        <span class="btn-text">Generate Answers</span>
        <span class="btn-loading hidden">Generating...</span>
      </button>
      <button id="paa-export-csv-btn" class="paa-btn paa-btn-secondary" disabled>Export CSV</button>
    </div>
  </div>

  <!-- Generated Answers Section -->
  <div id="paa-answers" class="paa-answers hidden">
    <div class="paa-answers-header">
      <h3>Generated Answers</h3>
      <div class="paa-answers-actions">
        <button id="paa-copy-html-btn" class="paa-btn paa-btn-secondary">Copy HTML</button>
        <button id="paa-copy-schema-btn" class="paa-btn paa-btn-secondary">Copy Schema</button>
        <button id="paa-copy-all-btn" class="paa-btn paa-btn-primary">Copy All (HTML + Schema)</button>
      </div>
    </div>

    <div id="paa-answers-list" class="paa-answers-list"></div>

    <!-- Preview Section -->
    <div class="paa-preview">
      <h4>Preview</h4>
      <div id="paa-preview-content" class="paa-preview-content"></div>
    </div>
  </div>

  <!-- Context Modal -->
  <div id="paa-context-modal" class="paa-modal hidden">
    <div class="paa-modal-content">
      <div class="paa-modal-header">
        <h3>Customize Answer Generation</h3>
        <button class="paa-modal-close">&times;</button>
      </div>
      <div class="paa-modal-body">
        <div class="paa-form-group">
          <label>Brand/Company Name (optional)</label>
          <input type="text" id="paa-context-brand" class="paa-input" placeholder="e.g., Acme Agency">
        </div>
        <div class="paa-form-group">
          <label>Target Audience (optional)</label>
          <input type="text" id="paa-context-audience" class="paa-input" placeholder="e.g., Small business owners">
        </div>
        <div class="paa-form-group">
          <label>Tone</label>
          <select id="paa-context-tone" class="paa-select">
            <option value="professional">Professional</option>
            <option value="casual">Casual</option>
            <option value="friendly">Friendly</option>
            <option value="authoritative">Authoritative</option>
          </select>
        </div>
        <div class="paa-form-group">
          <label class="paa-checkbox-label">
            <input type="checkbox" id="paa-context-cta">
            Include Call-to-Action
          </label>
        </div>
        <div class="paa-form-group" id="paa-cta-text-group" style="display: none;">
          <label>CTA Text</label>
          <input type="text" id="paa-context-cta-text" class="paa-input" placeholder="e.g., Contact us for a free consultation">
        </div>
      </div>
      <div class="paa-modal-footer">
        <button id="paa-context-cancel" class="paa-btn paa-btn-secondary">Cancel</button>
        <button id="paa-context-generate" class="paa-btn paa-btn-primary">Generate</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Configuration
  const API_BASE = 'https://your-worker.workers.dev/api';

  // State
  let currentQuestions = [];
  let currentAnswers = [];
  let authToken = null;

  // Get auth token from Memberstack (if available)
  function getAuthToken() {
    // Try Memberstack
    if (window.$memberstackDom) {
      return window.$memberstackDom.getCurrentToken().then(token => {
        authToken = token;
        return token;
      });
    }
    // Fallback: check for token in localStorage
    authToken = localStorage.getItem('paa_auth_token');
    return Promise.resolve(authToken);
  }

  // API call helper
  async function apiCall(endpoint, options = {}) {
    const token = await getAuthToken();

    const response = await fetch(`${API_BASE}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.headers,
      },
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ error: 'Request failed' }));
      throw new Error(error.error || 'Request failed');
    }

    return response.json();
  }

  // DOM Elements
  const elements = {
    keyword: document.getElementById('paa-keyword'),
    region: document.getElementById('paa-region'),
    depth: document.getElementById('paa-depth'),
    fetchBtn: document.getElementById('paa-fetch-btn'),
    results: document.getElementById('paa-results'),
    questionsList: document.getElementById('paa-questions-list'),
    totalCount: document.getElementById('paa-total-count'),
    selectedCount: document.getElementById('paa-selected-count'),
    selectAll: document.getElementById('paa-select-all'),
    deselectAll: document.getElementById('paa-deselect-all'),
    generateBtn: document.getElementById('paa-generate-btn'),
    exportCsvBtn: document.getElementById('paa-export-csv-btn'),
    answers: document.getElementById('paa-answers'),
    answersList: document.getElementById('paa-answers-list'),
    previewContent: document.getElementById('paa-preview-content'),
    copyHtmlBtn: document.getElementById('paa-copy-html-btn'),
    copySchemaBtn: document.getElementById('paa-copy-schema-btn'),
    copyAllBtn: document.getElementById('paa-copy-all-btn'),
    contextModal: document.getElementById('paa-context-modal'),
    contextBrand: document.getElementById('paa-context-brand'),
    contextAudience: document.getElementById('paa-context-audience'),
    contextTone: document.getElementById('paa-context-tone'),
    contextCta: document.getElementById('paa-context-cta'),
    contextCtaText: document.getElementById('paa-context-cta-text'),
    ctaTextGroup: document.getElementById('paa-cta-text-group'),
    contextCancel: document.getElementById('paa-context-cancel'),
    contextGenerate: document.getElementById('paa-context-generate'),
  };

  // Fetch PAA Questions
  async function fetchQuestions() {
    const keyword = elements.keyword.value.trim();
    if (!keyword) {
      alert('Please enter a keyword');
      return;
    }

    const region = elements.region.value;
    const depth = elements.depth.value;

    setLoading(elements.fetchBtn, true);
    elements.results.classList.add('hidden');
    elements.answers.classList.add('hidden');

    try {
      const data = await apiCall(`/paa/fetch?keyword=${encodeURIComponent(keyword)}&region=${region}&depth=${depth}`);
      currentQuestions = flattenQuestions(data.questions);
      renderQuestions(currentQuestions);
      elements.results.classList.remove('hidden');
    } catch (error) {
      alert('Error: ' + error.message);
    } finally {
      setLoading(elements.fetchBtn, false);
    }
  }

  // Flatten nested questions into flat array with parent reference
  function flattenQuestions(questions, parent = null, depth = 0) {
    let flat = [];
    for (const q of questions) {
      flat.push({
        question: q.question,
        type: q.type,
        snippet: q.snippet,
        parent: parent,
        depth: depth,
        selected: true,
      });
      if (q.children && q.children.length > 0) {
        flat = flat.concat(flattenQuestions(q.children, q.question, depth + 1));
      }
    }
    return flat;
  }

  // Render questions list
  function renderQuestions(questions) {
    elements.totalCount.textContent = questions.length;
    updateSelectedCount();

    elements.questionsList.innerHTML = questions.map((q, i) => `
      <div class="paa-question-item" style="padding-left: ${q.depth * 24}px">
        <label class="paa-question-label">
          <input type="checkbox" class="paa-question-checkbox" data-index="${i}" ${q.selected ? 'checked' : ''}>
          <div class="paa-question-content">
            <span class="paa-question-text">${escapeHtml(q.question)}</span>
            <span class="paa-question-type">${q.type}</span>
          </div>
        </label>
      </div>
    `).join('');

    // Add event listeners to checkboxes
    elements.questionsList.querySelectorAll('.paa-question-checkbox').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const index = parseInt(e.target.dataset.index);
        currentQuestions[index].selected = e.target.checked;
        updateSelectedCount();
      });
    });
  }

  function updateSelectedCount() {
    const selected = currentQuestions.filter(q => q.selected).length;
    elements.selectedCount.textContent = selected;
    elements.generateBtn.disabled = selected === 0;
    elements.exportCsvBtn.disabled = currentQuestions.length === 0;
  }

  // Generate answers
  async function generateAnswers() {
    const selected = currentQuestions.filter(q => q.selected);
    if (selected.length === 0) {
      alert('Please select at least one question');
      return;
    }

    const context = {
      brand: elements.contextBrand.value.trim() || undefined,
      audience: elements.contextAudience.value.trim() || undefined,
      tone: elements.contextTone.value,
      include_cta: elements.contextCta.checked,
      cta_text: elements.contextCta.checked ? elements.contextCtaText.value.trim() : undefined,
    };

    elements.contextModal.classList.add('hidden');
    setLoading(elements.generateBtn, true);

    try {
      const data = await apiCall('/paa/generate', {
        method: 'POST',
        body: JSON.stringify({
          questions: selected.map(q => ({ question: q.question, type: q.type })),
          context,
        }),
      });

      currentAnswers = data.answers;
      renderAnswers(data.answers);
      elements.answers.classList.remove('hidden');
    } catch (error) {
      alert('Error: ' + error.message);
    } finally {
      setLoading(elements.generateBtn, false);
    }
  }

  // Render answers
  function renderAnswers(answers) {
    elements.answersList.innerHTML = answers.map((a, i) => `
      <div class="paa-answer-item">
        <div class="paa-answer-header">
          <h4>${escapeHtml(a.question)}</h4>
          <span class="paa-answer-type">${a.type}</span>
        </div>
        <div class="paa-answer-content" contenteditable="true" data-index="${i}">
          ${a.answer_html}
        </div>
        <div class="paa-answer-meta">
          ${a.word_count} words
        </div>
      </div>
    `).join('');

    // Render preview
    elements.previewContent.innerHTML = generatePreviewHTML(answers);
  }

  function generatePreviewHTML(answers) {
    return answers.map(a => `
      <div class="paa-preview-item">
        <h4>${escapeHtml(a.question)}</h4>
        ${a.answer_html}
      </div>
    `).join('');
  }

  // Export CSV
  function exportCSV() {
    const headers = ['Question', 'Type', 'Parent'];
    const rows = currentQuestions.map(q => [
      `"${q.question.replace(/"/g, '""')}"`,
      q.type,
      q.parent ? `"${q.parent.replace(/"/g, '""')}"` : '',
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    downloadFile(csv, 'paa-questions.csv', 'text/csv');
  }

  // Copy functions
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('Copied to clipboard!');
    });
  }

  function getHTMLOutput() {
    const items = currentAnswers.map(a => `
  <div class="paa-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
    <h3 class="paa-question" itemprop="name">${escapeHtml(a.question)}</h3>
    <div class="paa-answer" itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
      <div itemprop="text">
        ${a.answer_html}
      </div>
    </div>
  </div>`).join('\n');

    return `<div class="paa-faq-section" itemscope itemtype="https://schema.org/FAQPage">
${items}
</div>`;
  }

  function getSchemaOutput() {
    const schema = {
      '@context': 'https://schema.org',
      '@type': 'FAQPage',
      mainEntity: currentAnswers.map(a => a.schema),
    };
    return `<script type="application/ld+json">
${JSON.stringify(schema, null, 2)}
<\/script>`;
  }

  // Utility functions
  function setLoading(btn, loading) {
    btn.disabled = loading;
    btn.querySelector('.btn-text').classList.toggle('hidden', loading);
    btn.querySelector('.btn-loading').classList.toggle('hidden', !loading);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'paa-toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }

  // Event listeners
  elements.fetchBtn.addEventListener('click', fetchQuestions);
  elements.keyword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') fetchQuestions();
  });

  elements.selectAll.addEventListener('click', () => {
    currentQuestions.forEach(q => q.selected = true);
    renderQuestions(currentQuestions);
  });

  elements.deselectAll.addEventListener('click', () => {
    currentQuestions.forEach(q => q.selected = false);
    renderQuestions(currentQuestions);
  });

  elements.generateBtn.addEventListener('click', () => {
    elements.contextModal.classList.remove('hidden');
  });

  elements.exportCsvBtn.addEventListener('click', exportCSV);

  elements.contextCta.addEventListener('change', () => {
    elements.ctaTextGroup.style.display = elements.contextCta.checked ? 'block' : 'none';
  });

  elements.contextCancel.addEventListener('click', () => {
    elements.contextModal.classList.add('hidden');
  });

  elements.contextGenerate.addEventListener('click', generateAnswers);

  document.querySelector('.paa-modal-close').addEventListener('click', () => {
    elements.contextModal.classList.add('hidden');
  });

  elements.copyHtmlBtn.addEventListener('click', () => copyToClipboard(getHTMLOutput()));
  elements.copySchemaBtn.addEventListener('click', () => copyToClipboard(getSchemaOutput()));
  elements.copyAllBtn.addEventListener('click', () => copyToClipboard(getHTMLOutput() + '\n\n' + getSchemaOutput()));

  // Initialize
  getAuthToken();
})();
</script>
